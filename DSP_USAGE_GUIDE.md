# 🎵 DSP 功能使用说明

## 📍 DSP 控件位置变更

### ✅ 新位置：主界面（BGM 音量下方）

```
K 歌主界面
├── 🔊 耳返开关
├── 🎧 耳返音量
├── 🎤 麦克风音量
├── 🎵 BGM音量
└── 🔇 智能降噪 ← 🆕 新位置（常驻控件）
```

### ❌ 旧位置已移除
- ~~音效弹窗中的降噪开关~~（已删除）
- ~~音效弹窗中的音高滑块~~（已删除，功能暂时禁用）

---

## 🎯 DSP 功能工作原理

### 1. 智能降噪 - 录音时实时处理

#### 工作流程：
```
开始录音 → 麦克风输入 → 【降噪处理】→ 【音效处理】→ 保存到录音段落
```

#### 关键理解：
- ✅ **录音时**开启降噪 → 录制的人声数据已经被降噪处理
- ✅ **试听时**播放的是录音时已处理的数据
- ⚠️ **试听时**无法更改降噪设置（因为数据已固定）

#### 正确使用方法：
```
步骤 1: 开始录音前，开启"智能降噪"开关
步骤 2: 开始录音
步骤 3: 录音过程中，降噪实时生效
步骤 4: 停止录音
步骤 5: 试听 → 听到的是降噪后的效果
```

### 2. 试听与 DSP 配置的关系

#### 问题：为什么试听时调整降噪没效果？

**答案**：试听播放的是**已经处理好**的音频数据，不会重新应用 DSP。

#### 录音与试听的数据流对比：

**录音时（DSP 生效）：**
```
麦克风
  ↓
【降噪】    ← 实时处理
  ↓
【音效】    ← 实时处理
  ↓
录音数据    ← 保存已处理的结果
```

**试听时（播放录音数据）：**
```
录音数据（已处理）
  ↓
【混音】BGM + 人声
  ↓
AVAudioPlayer 播放
  ↓
扬声器输出
```

#### 为什么这样设计？

1. **性能原因**：试听时重新处理会增加延迟和 CPU 负担
2. **数据完整性**：保留原始录音效果，避免重复处理导致质量损失
3. **所见即所得**：试听到的就是最终保存的效果

---

## 🛠️ 如何在试听时调整效果？

### 方案 A：重新录音（推荐）

如果对降噪效果不满意：

```
1. 删除当前录音段落
2. 调整降噪开关
3. 重新录音
4. 试听新效果
```

### 方案 B：调整其他参数

试听时**可以**调整的参数：
- ✅ BGM 音量
- ✅ 麦克风音量
- ✅ 音效类型（会重新生成预览）

试听时**无法**调整的参数：
- ❌ 降噪开关（录音时已固化）
- ❌ 音高修正（功能暂时禁用）

### 方案 C：实时参数预览（未来功能）

**计划实现**：在试听时重新处理音频
```objective-c
// 未来可能的实现
- (NSData *)previewWithReprocessing:(BOOL)reprocess {
    if (reprocess) {
        // 从 vocalData 重新应用新的 DSP 参数
        return [self reprocessVocalDataWithNewSettings];
    }
    return [self previewSynthesizedAudio];
}
```

**挑战**：
- 增加 CPU 负担
- 延迟增加
- 需要保留原始未处理的人声数据

---

## 📊 当前 DSP 状态总结

### ✅ 完全可用的功能

#### 1. 智能降噪
- **状态**: ✅ 完全可用
- **位置**: 主界面，BGM 音量下方
- **使用**: 录音前开启，录音时实时生效
- **效果**: SNR 提升约 13dB

#### 2. 传统音效（12种）
- **状态**: ✅ 完全可用
- **位置**: 音效弹窗
- **包括**:
  - 原声、录音棚、音乐厅
  - 超级混响、唱将、歌神
  - 空灵、磁性、明亮
  - 自动修音*、升调+3*、降调-3*
  
  *注：标记项使用 EQ 模拟，非真实音高变换

### ⚠️ 暂时禁用的功能

#### 1. 音高修正
- **状态**: ⚠️ 开发中
- **原因**: 缓冲区管理问题导致崩溃
- **替代方案**: 
  - 使用"升调+3"（高频增强 EQ）
  - 使用"降调-3"（低频增强 EQ）
- **计划**: 后续使用完整的 SoundTouch 库

#### 2. Auto-Tune
- **状态**: ⚠️ 开发中
- **原因**: 需要音高检测算法
- **替代方案**: 使用"自动修音"音效（增强版歌神）
- **计划**: 集成 YIN/PYIN 音高检测

---

## 🎮 使用场景示例

### 场景 1: 嘈杂环境录音

**问题**: 背景噪音大，人声不清晰

**解决方案**:
```
步骤 1: 开启"智能降噪"✅
步骤 2: 选择"录音棚"音效
步骤 3: 调低 BGM 音量（避免抢掉人声）
步骤 4: 开始录音
步骤 5: 试听效果
```

**效果**: 背景噪音明显降低，人声清晰

### 场景 2: 专业级录制

**最佳配置**:
```
智能降噪: ✅ 开启
音效: 歌神
耳返: ✅ 开启（监听自己声音）
麦克风音量: 80-90%
BGM 音量: 30-40%
```

### 场景 3: 调整录音效果

**如果录音后发现问题**:

| 问题 | 可以试听调整 | 需要重录 |
|------|------------|---------|
| BGM 太响 | ✅ 降低 BGM 音量 | |
| 人声太小 | ✅ 提高麦克风音量 | |
| 音效不合适 | ✅ 更换音效类型 | |
| 噪音太大 | | ❌ 重录（开启降噪）|
| 音高不对 | | ❌ 重录（或等功能完善）|

---

## 🔧 技术细节：为什么试听时不重新处理？

### 当前架构

**录音段落存储**:
```objective-c
@interface RecordingSegment : NSObject
@property NSMutableData *audioData;  // 混合后的数据（BGM+人声）
@property NSMutableData *vocalData;  // 原始人声数据（已应用降噪+音效）
@property VoiceEffectType appliedEffect;  // 录音时的音效
@property float appliedMicVolume;  // 录音时的麦克风音量
@end
```

**关键点**:
- `vocalData` 保存的是**已经过降噪和音效处理**的人声
- 试听时使用 `vocalData` + BGM 混合
- **没有保存**未处理的原始麦克风数据

### 如果要实现试听时重新处理

**需要修改**:
```objective-c
@property NSMutableData *rawVocalData;  // 🆕 原始未处理数据
```

**试听流程修改**:
```objective-c
- (NSData *)previewWithNewDSP {
    for (RecordingSegment *segment in segments) {
        // 1. 从 rawVocalData 读取原始数据
        SInt16 *rawData = segment.rawVocalData.bytes;
        
        // 2. 重新应用降噪
        if (self.enableNoiseReduction) {
            [self.noiseReducer processInt16Samples:rawData ...];
        }
        
        // 3. 重新应用音效
        [self.voiceEffectProcessor processAudioBuffer:rawData ...];
        
        // 4. 混合 BGM
        // ...
    }
}
```

**代价**:
- 内存占用翻倍（需要保存原始数据）
- CPU 占用增加（实时重新处理）
- 延迟增加（处理时间）

---

## 💡 最佳实践建议

### 1. 录音前设置好参数

在开始录音**之前**：
- ✅ 检查降噪开关状态
- ✅ 选择合适的音效
- ✅ 调整麦克风音量
- ✅ 测试耳返效果

### 2. 录音过程中

- ✅ 专注演唱，不要调整参数
- ✅ 保持麦克风距离稳定
- ✅ 避免突然的大声或轻声

### 3. 试听调整

- ✅ 调整 BGM 和麦克风音量平衡
- ✅ 尝试不同的音效类型
- ❌ 不要期望降噪效果会改变

### 4. 如果不满意

- ✅ 使用"回退"功能删除不满意的段落
- ✅ 调整参数后重新录制该段落
- ✅ 可以分段录音，每段使用不同参数

---

## 📞 常见问题 FAQ

### Q1: 为什么我在试听时调整降噪开关没反应？
**A**: 降噪只在录音时生效，试听播放的是录音时已处理的数据。

### Q2: 如何在试听时听到降噪效果？
**A**: 录音前开启降噪，录音时降噪会实时处理，试听时就能听到降噪后的效果。

### Q3: 可以重新处理已录制的音频吗？
**A**: 当前版本不支持。建议删除段落后重新录音。

### Q4: 为什么音高修正功能用不了？
**A**: 该功能暂时禁用以防止崩溃。可使用"升调+3"或"降调-3"音效（EQ 模拟）。

### Q5: 降噪效果不明显怎么办？
**A**: 
1. 确保录音前已开启降噪
2. 当前是简化版降噪，效果有限
3. 建议在相对安静的环境录音
4. 未来会升级到完整版 RNNoise

### Q6: 试听时可以调整哪些参数？
**A**: 
- ✅ BGM 音量
- ✅ 麦克风音量  
- ✅ 音效类型
- ❌ 降噪开关（无效）

---

## 🚀 未来改进计划

### 短期（1-2周）
- [ ] 优化降噪效果（使用完整 RNNoise）
- [ ] 修复音高修正崩溃问题
- [ ] 添加降噪强度调节

### 中期（1个月）
- [ ] 支持试听时重新处理（可选功能）
- [ ] 实现真正的 Auto-Tune
- [ ] 添加多频段 EQ

### 长期（3-6个月）
- [ ] 保存原始未处理数据
- [ ] 实时 DSP 参数调整
- [ ] AI 智能混音

---

**版本**: 1.0.1  
**更新**: 2025-10-15  
**状态**: 降噪可用，试听流程已优化

**享受你的 K 歌体验！** 🎤🎵✨


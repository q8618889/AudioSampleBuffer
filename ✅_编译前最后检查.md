# ✅ 编译前最后检查

## 已修复的问题

1. ✅ **FLOATING_POINT 定义**
   - arch.h 现在无条件包含 config.h
   - config.h 使用防护宏确保 FLOATING_POINT=1

2. ✅ **头文件路径**
   - 已调整为 SpeexDSP/speex/ 结构

3. ✅ **reset 函数不存在**
   - 已改用重新初始化

---

## 🎯 Xcode 必须操作

### 步骤 1: 移除测试文件

在 **Build Phases** → **Compile Sources** 中，删除这些文件：

❌ 删除：
- `testresample2.c`
- `testresample.c`  
- `testdenoise.c`
- `testecho.c`
- `testjitter.c`
- `scal.c`

✅ 保留这 10 个核心文件：
1. `preprocess.c`
2. `mdf.c`
3. `resample.c`
4. `kiss_fft.c`
5. `kiss_fftr.c`
6. `fftwrap.c`
7. `filterbank.c`
8. `buffer.c`
9. `jitter.c`
10. `smallft.c`

### 步骤 2: 确认 Build Settings

**Build Settings** → 搜索 **Other C Flags**

确保包含（可选，config.h 已处理）：
```
-DHAVE_CONFIG_H
-DFLOATING_POINT=1
-DUSE_KISS_FFT=1
```

如果已经在 config.h 中定义，这些标志是可选的。

### 步骤 3: Clean Build

1. `Cmd + Shift + K` - Clean Build Folder
2. `Cmd + B` - Build

---

## 🔍 如何确认测试文件已删除

在终端执行：
```bash
cd AudioSampleBuffer/Karaoke/DSP/SpeexDSP
ls test*.c scal.c 2>/dev/null || echo "✅ 测试文件已删除"
```

应该显示：`✅ 测试文件已删除`

---

## 📋 核心文件清单

如需查看当前的源文件：
```bash
cd AudioSampleBuffer/Karaoke/DSP/SpeexDSP  
ls *.c
```

应该只显示 10 个文件：
```
buffer.c
fftwrap.c
filterbank.c
jitter.c
kiss_fft.c
kiss_fftr.c
mdf.c
preprocess.c
resample.c
smallft.c
```

---

## ✨ 编译成功后

如果编译成功，你会看到：
```
Build Succeeded
```

然后可以开始使用 SpeexDSP 功能：

```objective-c
// 在 VoiceEffectProcessor.mm 中
#import "SpeexDSPBridge.h"

// 初始化
int frameSize = (int)(sampleRate * 0.005);  // 5ms
self.speexPreprocessor = [[SpeexPreprocessor alloc] initWithFrameSize:frameSize 
                                                           sampleRate:(int)sampleRate];

// 配置 AGC
[self.speexPreprocessor setAGCEnabled:YES];
[self.speexPreprocessor setAGCLevel:12000];
[self.speexPreprocessor setAGCMaxGain:25];

// 处理音频
float vadProb = [self.speexPreprocessor processSamples:buffer count:sampleCount];
```

---

## 🚨 如果仍有错误

### 错误: "FLOATING_POINT not defined"
**解决:** 在 Build Settings → Other C Flags 手动添加：
```
-DFLOATING_POINT=1
```

### 错误: "test*.c file not found"
**解决:** 在 Build Phases → Compile Sources 中手动删除这些文件的引用

### 错误: "config.h not found"
**解决:** 确保 config.h 在 SpeexDSP 目录中，并且已添加到 Xcode 项目

---

现在执行：
1. ✅ 移除测试文件（Build Phases）
2. ✅ Clean Build (`Cmd + Shift + K`)
3. ✅ Build (`Cmd + B`)

应该成功编译！🎉
